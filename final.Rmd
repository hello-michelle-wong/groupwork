---
title: "Final Report"
author: "Group 5: Megan Lui, Michelle Wong, Yael Yossefy, Dirgh Shah"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    number_sections: no
    theme: cerulean
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  word_document:
    toc: no
  pdf_document:
    toc: no
editor_options: 
  markdown: 
    wrap: 72
---

```{r,echo=FALSE}
knitr::opts_chunk$set(cache=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

## Introduction

### Scientific Question:

Does the relationship between EtCO2 and AMC behave differently in the
presence of relevant medical history?

### Clinical relevance:

Observing the relationship between EtCO2 (end-tidal carbon dioxide) and
AMC (area of maximum compression) is crucial to understanding the
quality of chest compression during CPR (cardiopulmonary resuscitation),
a life-saving procedure during cardiac arrests. Chest compressions are
crucial to reviving a patient or achieving ROSC or Return to Spontaneous
Circulation, though they requires adequate rate, depth, and location for
the best results. However, CPR guidelines are not as precise, as
differences in body size and histories of chronic disease can alter the
heart's location. When patients have compression in the aortic root,
there is an obstruction of blood flow from the heart and can limit
effective perfusion and worsen the prognosis. Compressions over the left
ventricle or LV can improve the blood circulation and lead to
higher-quality CPR. This relationship between EtCO2 (where higher levels
have been shown to correlate with better blood flow from past studies)
and AMC may differ dependent on a patient's history, as these conditions
can impact the ventilation-perfusion mismatch or other presenting
symptoms.

## Methods

### Design of Study:

The metabolic syndrome and cognitive function study is a retrospective
observational analysis which focuses on investigating the relationship
between EtCO2 and the AMC during CPR and whether this relationship is
affected by the presence of relevant medical histories of patients.

This study focuses on 2 primary areas of compression, the left ventricle
(LV) and the left ventricle outflow tract (LVOT)/aortic root, and how
compression over these AMCs impact EtCO2 levels and whether this impact
changes by the CPR patients' pre existing medical conditions, such as
coronary artery disease, congestive hearth failure, chronic kidney
disease, diabetes mellitus and myocardial infarction.

### Data set Details:

The data set consists of 129 cases of in-hospital cardiac arrests where
transesophageal echocardiography (TEE) imaging was employed during CPR.
This advanced imaging technique is used to identify the specific area of
the chest targeted for compression to precisely classify the AMC - LV or
LVOT.

Key variables in the data set include:

-   Dependent Variable:

    -   EtCO2: Measured during CPR, represents levels of exhaled CO2 and
        serves as a proxy for cardiac output.

-   Independent Variables:

    -   AMC: Areas of compression, classified as either LV or LVOT.

    -   Medical History: Binary indicators for conditions like coronary
        artery diseas (hist1), congestive hearth failure (hist2),
        chronic kidney disease (hist3), diabetes mellitus (hist4), and
        myocardial infarction (hist5).

-   Covariates:

    -   Demographics like race and gender.

    -   TEE operator experience level (e.g. attending physicain,
        resident, etc.).

    -   Type of CPR performed (manual, mechanical, alternating).

    -   Timing of cardiac arrest (known or approximated).

First, the data set underwent pre-processing and cleaning, which
included the removal of invalid data entries. The next step involved
converting the numeric values flagged as outliers (e.g. placeholder
values like 9999) to missing (NA) values and excluding them from the
analysis.

### Cohort:

The study cohort consisted of adult patients who had experienced
in-hospital cardiac arrest and received CPR where TEE was used. The
inclusion criteria required proper TEE imaging data to identify the
precise location of AMC and valid measurements of EtCO2 levels. patients
with any significant missing data were excluded. After pre-processing
and cleaning, the data set included 106 valid observations (patients)
for further analysis.

### Analysis Methodology:

A multivariable linear model was implemented to analyse the relationship
between EtCO2 level and AMC. Interaction terms between AMC the the
medical history variables were used in this model to asses whether the
relationship between EtCO2 and AMC varied by the presence of 5 specific
pre-existing medical conditions.

The analysis included two models:

-   A reduced model, which included only the main effects of AMC and
    medical history.

-   A full model, which included interaction terms to evaluate whether
    medical history affected the relationship between EtCO2 and AMC.

An Analysis of Variance (ANOVA) test was used to compare these models
and evaluate the contribution of the interaction terms to model fit.

### Rationale:

A linear regression model was implemented based on the assumption that
the relationship between EtCO2 and AMC is linear, as CO2 levels in the
blood reflect cardiac output which is influnced by the area of
compression (LV or LVOT). We assume higher EtCO2 levels when the AMC is
LV. This specif approach allows for testing the main effects while
including interaction terms to study more complex relationships. The
inclusion of these interaction terms is very crucial for identifying
whether specif medical histories alter the impact of AMC on EtCO2.

Assumptions include:

-   Linearity and Homoscedasticity: Checked via residual plots.

-   Independence: Verified using the Durbin-Watson test.

-   Normality of Residuals: Assessed through Q-Q plots.

-   Multicollinearity: Evaluated using Variance Inflation Factors (VIF),
    with all predictors having suitable values (\< 5).

This methodological approach addresses potential confounding factors and
statistical validity while guaranteeing a thorough investigation of the
research question.

```{r}
library(readxl)
data <- read_excel("cardiac_arrests.xlsx")
#head(data)
```

### Cleaning

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)

data <- data %>%
  mutate(across(where(is.numeric), ~ replace(.x, .x == 9999, NA))) 

data$race <- factor(data$race, levels = c(1, 2, 3, 4, 99), 
                    labels = c("White", "Black/African American", 
                               "Asian", "Latinx", "Other"))
data$amc <- factor(data$amc, levels = c(1, 2), 
                   labels = c("LV", "LVOT/Aortic root"))
data$op_level <- factor(data$op_level, levels = c(1, 2, 3, 99), 
                        labels = c("Attending physician", "Fellow", 
                                   "Resident", "Other"))
data$cpr_type <- factor(data$cpr_type, levels = c(1, 2, 3), 
                        labels = c("Manual", "Mechanical", "Alternating"))
data$hist1 <- factor(data$hist1, levels = c(0, 1), 
                     labels = c("No", "Yes"))

data$hist2 <- factor(data$hist2, levels = c(0, 1), 
                     labels = c("No", "Yes"))

data$hist3 <- factor(data$hist3, levels = c(0, 1), 
                     labels = c("No", "Yes"))

data$hist4 <- factor(data$hist4, levels = c(0, 1), 
                     labels = c("No", "Yes"))

data$hist5 <- factor(data$hist5, levels = c(0, 1), 
                     labels = c("No", "Yes"))

data$rosc <- factor(data$rosc, levels = c(0, 1), 
                    labels = c("No", "Yes"))

data$survival <- factor(data$survival, levels = c(0, 1), 
                        labels = c("No", "Yes"))

data$time_approx <- factor(data$time_approx, levels = c(0, 1), 
                           labels = c("Known", "Approximated"))

#summary(data)
cleaned_data <- na.omit(data)
```

### Assumptions Made:

```{r}
# Fit a linear regression model 

# look into why it's 1 vs 2 
normal_model <- lm(etco2 ~ amc + hist1 + hist2 + hist3 + 
                          hist4 + hist5 + amc:hist1 + amc:hist2 + amc:hist3 + 
                          amc:hist4 + amc:hist5, 
                        data = cleaned_data)

summary(normal_model)
```

1.  Linearity and Homoscedasticity (Constant Variance) The relationship
    between the predictor(s) (independent variables) and the outcome
    (dependent variable) should be linear. This means that changes in
    the predictor(s) should produce proportional changes in the
    outcome.For homoscedasticity, the variance of the residuals (errors)
    should be constant across all levels of the independent variables.

```{r}
plot(normal_model, which = 1)
```

2.  Independence: The residuals (errors) from the model should be
    independent. This means that the error associated with one
    observation is not correlated with the error of another observation.
    A value close to 2 indicates no autocorrelation.

```{r}
library(lmtest)
dwtest(normal_model)
```

3.  Normality of Residuals: The residuals should be normally
    distributed.

```{r}
plot(normal_model, which = 2)
```

4.  No Perfect Multicollinearity: The independent variables should not
    be highly correlated with each other. If they are, it becomes
    difficult to isolate the individual effects of each predictor. In
    ANOVA, this is typically not an issue if the independent variables
    are categorical (factors), but in multiple regression, it could be.

VIF \< 5: Acceptable (low multicollinearity). VIF between 5 and 10:
Moderate multicollinearity, may warrant investigation. VIF \> 10:
Problematic (high multicollinearity), often considered a "bad" value.

```{r}
library(car)
vif(normal_model, 'predictor')
vif(normal_model)
```

## Results

### Tables Figures Statistics

First, let's look at the relationship between AMC and EtCO2, without accounting for different histories of disease.

```{r}
ggplot(cleaned_data, aes(x = amc, y = etco2))+
  geom_boxplot() + 
  labs(x = "AMC", y = "EtCO2", title = "BoxPlots of EtCO2 vs. AMC") + 
  ylim(0,30)
```

```{r}
favstats(cleaned_data$etco2[cleaned_data$amc=="LV"])
favstats(cleaned_data$etco2[cleaned_data$amc=="LVOT/Aortic root"])

#library(dplyr)
#library(mosaic)

#cleaned_data |>
#  group_by(amc) |>
#  favstats(etco2)
```

```{r}
ggplot(cleaned_data, aes(x = etco2, fill = amc)) +
  geom_density(alpha = 0.5) + 
  labs(x = "EtCO2", y = "Density", fill = "AMC")

```

Now let's look at how history of disease affects this relationships:


```{r}
library(gridExtra)

plots <- lapply(c("hist1", "hist2", "hist3", "hist4", "hist5"), function(hist_var) {
  ggplot(cleaned_data, aes(x = amc, y = etco2, fill = get(hist_var))) +
  geom_boxplot(outlier.shape = NA) +
  labs(x = "AMC", y = "EtCO2", fill = paste(hist_var)) +
  scale_fill_manual(values = c("lightblue", "salmon")) +
  ylim(0,30) + 
  theme_minimal() +
  theme(legend.position = "top") 
})

# Arrange the plots in a grid layout (2 rows, 3 columns or adjust as needed)
grid.arrange(grobs = plots, ncol = 3)
```

```{r}
ggplot(cleaned_data, aes(x = etco2, fill = amc)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ hist1) +
  labs(title = "Density of EtCO2 Colored by AMC", subtitle = " Wrapped by History of *insert hist*", fill = "AMC", x = "EtCO2 (mmHg)", y = "Density")

```
### Exploratory/Descriptive Analysis: Main Statistical Analysis:

The p-value (0.5541) for the F-test is larger than the typical
significance threshold of 0.05, meaning the addition of the interaction
terms (amc:hist1 and amc:hist3) does not significantly improve the
model. The RSS difference between the two models is relatively small
(63.984), suggesting that the interactions do not provide a substantial
increase in explanatory power.

However, the Residual sum of squares (RSS) which measures the total
deviation of the predicted values from the actual values, is lower for
Model 2 (5224.8) compared to Model 1 (5288.8), indicating a marginal
improvement in fit when the interaction terms are included.

```{r}
reduced_model <- lm(etco2 ~ amc + hist1 + hist2 + hist3 + hist4 + hist5, data = cleaned_data)

new_model <- lm(etco2 ~ amc + hist1 + hist2 + hist3 + 
                          hist4 + hist5 + amc:hist1 + amc:hist3, 
                        data = cleaned_data)

# Compare models, talk about clinical signficiance as why 
anova(reduced_model, new_model)
```

```{r}
reduced_model <- lm(etco2 ~ amc + hist1 + hist2 + hist3 + hist4 + hist5, data = cleaned_data)

new_model <- lm(etco2 ~ amc + hist1 + hist2 + hist3 + 
                          hist4 + hist5 + amc:hist1 + amc:hist3, 
                        data = cleaned_data)

# Compare models, talk about clinical signficiance as why 
anova(reduced_model, new_model)
```

## Conclusions

Main Findings: Answer Scientific Question: Limitations:

## References

Citations References
